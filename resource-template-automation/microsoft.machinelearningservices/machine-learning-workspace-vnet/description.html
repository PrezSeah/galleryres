<h1 id="azure-machine-learning-workspace-secure-network-configuration-">Azure Machine Learning workspace (secure network configuration)</h1>
<p><img src="./machine-learning-workspace-vnet.png" alt="machine-learning-workspace-vnet">
<p><img src="https://azurequickstartsservice.blob.core.windows.net/badges/quickstarts/microsoft.machinelearningservices/machine-learning-workspace-vnet/PublicLastTestDate.svg" alt="Azure Public Test Date">
<img src="https://azurequickstartsservice.blob.core.windows.net/badges/quickstarts/microsoft.machinelearningservices/machine-learning-workspace-vnet/PublicDeployment.svg" alt="Azure Public Test Result"></p>
<p><img src="https://azurequickstartsservice.blob.core.windows.net/badges/quickstarts/microsoft.machinelearningservices/machine-learning-workspace-vnet/FairfaxLastTestDate.svg" alt="Azure US Gov Last Test Date">
<img src="https://azurequickstartsservice.blob.core.windows.net/badges/quickstarts/microsoft.machinelearningservices/machine-learning-workspace-vnet/FairfaxDeployment.svg" alt="Azure US Gov Last Test Result"></p>
<p><img src="https://azurequickstartsservice.blob.core.windows.net/badges/quickstarts/microsoft.machinelearningservices/machine-learning-workspace-vnet/BestPracticeResult.svg" alt="Best Practice Check">
<img src="https://azurequickstartsservice.blob.core.windows.net/badges/quickstarts/microsoft.machinelearningservices/machine-learning-workspace-vnet/CredScanResult.svg" alt="Cred Scan Check"></p>
<p><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FPrezSeah%2Fgalleryres%2Fmain%2Fresource-template-automation%2Fmicrosoft.machinelearningservices%2Fmachine-learning-workspace-vnet%2Fazuredeploy.json"><img src="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true" alt="Deploy To Azure"></a>
<a href="http://armviz.io/#/?load=https%3A%2F%2Fraw.githubusercontent.com%2FPrezSeah%2Fgalleryres%2Fmain%2Fresource-template-automation%2Fmicrosoft.machinelearningservices%2Fmachine-learning-workspace-vnet%2Fazuredeploy.json"><img src="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/visualizebutton.svg?sanitize=true" alt="Visualize"></a></p>
<p>This template is an advanced Azure Machine Learning workspace creation templates which support:</p>
<ul>
<li>Create workspace with existing dependent resources like storage account, application insights, key vault or container registry.</li>
<li>Create workspace with auto-approval or manual approval private endpoint, both new VNET and existing vnet is supported.</li>
<li>Create workspace with customer managed key.</li>
<li>Create workspace with link to Azure Databricks workspace.</li>
<li>Create workspace with dependent resources(new resources only) behind virtual network.</li>
<li>Create workspace with user assigned identity.</li>
</ul>
<h2 id="supported-scenarios">Supported Scenarios</h2>
<p>The following commands show the advanced scenarios for workspace creation.</p>
<h3 id="create-machine-learning-workspace-with-existing-dependent-resources">Create machine learning workspace with existing dependent resources</h3>
<p>This command creates a workspace with private endpoint.</p>
<pre><code class="lang-PowerShell"># <span class="hljs-keyword">For</span> deployment <span class="hljs-keyword">with</span> existing resources, <span class="hljs-keyword">use</span> <span class="hljs-string">"existing"</span> <span class="hljs-keyword">for</span> the option <span class="hljs-keyword">and</span> resource <span class="hljs-keyword">group</span> name <span class="hljs-keyword">is</span> required.

# Create a workspace <span class="hljs-keyword">with</span> existing storage account, key vault <span class="hljs-keyword">and</span> appinsights
<span class="hljs-keyword">New</span>-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -Name <span class="hljs-string">"deploymentname"</span> -storageAccountOption <span class="hljs-string">"existing"</span> -storageAccountResourceGroupName <span class="hljs-string">"existing-storage-rg"</span> -storageAccountName <span class="hljs-string">"existing-storage-name"</span> -keyVaultOption <span class="hljs-string">"existing"</span> -keyVaultResourceGroupName <span class="hljs-string">"existing-kv-rg"</span> -keyVaultName <span class="hljs-string">"existing-kv-name"</span> -applicationInsightsOption <span class="hljs-string">"existing"</span> -applicationInsightsResourceGroupName <span class="hljs-string">"existing-ai-rg"</span> -applicationInsightsName <span class="hljs-string">"existing-ai-name"</span> -identityType <span class="hljs-string">"systemAssigned"</span>
</code></pre>
<h3 id="create-machine-learning-workspace-with-private-endpoint">Create machine learning workspace with private endpoint</h3>
<p>This command creates a workspace with private endpoint.</p>
<pre><code class="lang-PowerShell"># The deployment <span class="hljs-keyword">is</span> only valid <span class="hljs-keyword">in</span> regions which support <span class="hljs-keyword">private</span> endpoints. <span class="hljs-keyword">For</span> manual approval <span class="hljs-keyword">private</span> endpoint, just <span class="hljs-keyword">set</span> privateEndpointType=<span class="hljs-string">"ManualApproval"</span>

# Create a workspace <span class="hljs-keyword">with</span> <span class="hljs-keyword">private</span> endpoint
<span class="hljs-keyword">New</span>-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -Name <span class="hljs-string">"deploymentname"</span> -privateEndpointType <span class="hljs-string">"AutoApproval"</span>

# Create a workspace <span class="hljs-keyword">with</span> <span class="hljs-keyword">private</span> endpoint <span class="hljs-keyword">with</span> user specified virtual network name
<span class="hljs-keyword">New</span>-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -Name <span class="hljs-string">"deploymentname"</span> -privateEndpointType <span class="hljs-string">"AutoApproval"</span> -vnetName <span class="hljs-string">"vnet"</span> -subnetName <span class="hljs-string">"subnet"</span>

# Create a workspace <span class="hljs-keyword">with</span> <span class="hljs-keyword">private</span> endpoint <span class="hljs-keyword">with</span> user specified existing vnet
<span class="hljs-keyword">New</span>-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -Name <span class="hljs-string">"deploymentname"</span> -privateEndpointType <span class="hljs-string">"AutoApproval"</span> -vnetName <span class="hljs-string">"vnet"</span> -vnetOption <span class="hljs-string">"existing"</span> -vnetResourceGroupName <span class="hljs-string">"rg"</span> -subnetName <span class="hljs-string">"subnet"</span> -subnetOption <span class="hljs-string">"existing"</span>
</code></pre>
<h3 id="create-machine-learning-workspace-with-resources-behind-virtual-network">Create machine learning workspace with resources behind virtual network</h3>
<p>This command is an example of creating workspace with resource behind vnet.</p>
<pre><code class="lang-PowerShell"><span class="hljs-comment"># Parameter 'vnetOption' is required for this scenario and should not be 'none'. The example shows how to put the storage account behind vnet. You can also apply the scenario into key vault and container registry. For container registry, only 'Premium' sku is supported.</span>

<span class="hljs-comment"># Create a workspace with storage account behind a new vnet.</span>
New-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"deploymentname"</span> -storageAccountBehindVNet <span class="hljs-string">"true"</span> -vnetOption <span class="hljs-string">"new"</span> -vnetName <span class="hljs-string">"vnet"</span>

<span class="hljs-comment"># Create a workspace with storage account behind an existing vnet and an existing subnet.</span>
<span class="hljs-comment"># Prerequisite: Subnet should have Microsoft.Storage service endpoint</span>
<span class="hljs-comment"># Enable service endpoint</span>
Get-AzVirtualNetwork -ResourceGroupName <span class="hljs-string">"rg"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"vnet"</span> | Set-AzVirtualNetworkSubnetConfig -<span class="hljs-keyword">Name</span> <span class="hljs-string">"subnet"</span> -AddressPrefix <span class="hljs-string">"&lt;subnet prefix&gt;"</span> -ServiceEndpoint <span class="hljs-string">"Microsoft.Storage"</span> | Set-AzVirtualNetwork
<span class="hljs-comment"># Deployment</span>
New-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"deploymentname"</span> -storageAccountBehindVNet <span class="hljs-string">"true"</span> -vnetOption <span class="hljs-string">"existing"</span> -vnetName <span class="hljs-string">"vnet"</span> -vnetResourceGroupName <span class="hljs-string">"rg"</span> -subnetName <span class="hljs-string">"subnet"</span> -subnetOption <span class="hljs-string">"existing"</span>

<span class="hljs-comment"># Create a workspace with all dependent resources behind a new vnet</span>
New-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"deploymentname"</span> -containerRegistryOption <span class="hljs-string">"new"</span> -containerRegistrySku <span class="hljs-string">"Premium"</span> -storageAccountBehindVNet <span class="hljs-string">"true"</span> -keyVaultBehindVNet <span class="hljs-string">"true"</span> -containerRegistryBehindVNet <span class="hljs-string">"true"</span> -vnetOption <span class="hljs-string">"new"</span> -vnetName <span class="hljs-string">"vnet"</span>

<span class="hljs-comment"># Create a workspace with all dependent resources behind an existing vnet</span>
<span class="hljs-comment"># Service endpoints</span>
Get-AzVirtualNetwork -ResourceGroupName <span class="hljs-string">"rg"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"vnet"</span> | Set-AzVirtualNetworkSubnetConfig -<span class="hljs-keyword">Name</span> <span class="hljs-string">"subnet"</span> -AddressPrefix <span class="hljs-string">"&lt;subnet prefix&gt;"</span> -ServiceEndpoint <span class="hljs-string">"Microsoft.Storage"</span> | Set-AzVirtualNetwork
Get-AzVirtualNetwork -ResourceGroupName <span class="hljs-string">"rg"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"vnet"</span> | Set-AzVirtualNetworkSubnetConfig -<span class="hljs-keyword">Name</span> <span class="hljs-string">"subnet"</span> -AddressPrefix <span class="hljs-string">"&lt;subnet prefix&gt;"</span> -ServiceEndpoint <span class="hljs-string">"Microsoft.KeyVault"</span> | Set-AzVirtualNetwork
Get-AzVirtualNetwork -ResourceGroupName <span class="hljs-string">"rg"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"vnet"</span> | Set-AzVirtualNetworkSubnetConfig -<span class="hljs-keyword">Name</span> <span class="hljs-string">"subnet"</span> -AddressPrefix <span class="hljs-string">"&lt;subnet prefix&gt;"</span> -ServiceEndpoint <span class="hljs-string">"Microsoft.ContainerRegistry"</span> | Set-AzVirtualNetwork
<span class="hljs-comment"># Deployment</span>
New-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -location <span class="hljs-string">"westus2"</span> -<span class="hljs-keyword">Name</span> <span class="hljs-string">"deploymentname"</span> -containerRegistryOption <span class="hljs-string">"new"</span> -containerRegistrySku <span class="hljs-string">"Premium"</span> -storageAccountBehindVNet <span class="hljs-string">"true"</span> -keyVaultBehindVNet <span class="hljs-string">"true"</span> -containerRegistryBehindVNet <span class="hljs-string">"true"</span> -vnetOption <span class="hljs-string">"existing"</span> -vnetName <span class="hljs-string">"vnet"</span> -vnetResourceGroupName <span class="hljs-string">"rg"</span> -subnetName <span class="hljs-string">"subnet"</span> -subnetOption <span class="hljs-string">"existing"</span>
</code></pre>
<h3 id="create-machine-learning-workspace-with-user-assigned-identity">Create machine learning workspace with user assigned identity</h3>
<p>This command is an example of creating workspace with user assigned identity.</p>
<pre><code class="lang-Powershell">New-AzResourceGroupDeployment -ResourceGroupName <span class="hljs-string">"rg"</span> -TemplateFile <span class="hljs-string">".\azuredeploy.json"</span> -workspaceName <span class="hljs-string">"workspaceName"</span> -<span class="hljs-keyword">location</span> <span class="hljs-title">"westus2</span><span class="hljs-string">" -Name "</span>deploymentname<span class="hljs-string">" -storageAccountOption "</span>existing<span class="hljs-string">" -storageAccountResourceGroupName "</span>existing-storage-rg<span class="hljs-string">" -storageAccountName "</span>existing-storage-name<span class="hljs-string">" -keyVaultOption "</span>existing<span class="hljs-string">" -keyVaultResourceGroupName "</span>existing-kv-rg<span class="hljs-string">" -keyVaultName "</span>existing-kv-name<span class="hljs-string">" -applicationInsightsOption "</span>existing<span class="hljs-string">" -applicationInsightsResourceGroupName "</span>existing-ai-rg<span class="hljs-string">" -applicationInsightsName "</span>existing-ai-name<span class="hljs-string">" -identityType "</span>userAssigned<span class="hljs-string">" -primaryUserAssignedIdentity "</span>/subscriptions/<span class="hljs-number">00000000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">000000000000</span>/resourceGroups/rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai<span class="hljs-string">"</span>
</code></pre>
<h2 id="learn-more">Learn more</h2>
<p>If you are new to Azure Machine Learning, see:</p>
<ul>
<li><a href="https://azure.microsoft.com/services/machine-learning-service/">Azure Machine Learning service</a></li>
<li><a href="https://docs.microsoft.com/azure/machine-learning/">Azure Machine Learning documentation</a></li>
<li><a href="https://docs.microsoft.com/azure/templates/microsoft.machinelearningservices/allversions">Azure Machine Learning template reference</a></li>
<li><a href="https://azure.microsoft.com/resources/templates/">Quickstart templates</a></li>
</ul>
<p>If you are new to template development, see:</p>
<ul>
<li><a href="https://docs.microsoft.com/azure/azure-resource-manager/">Azure Resource Manager documentation</a></li>
<li><a href="https://docs.microsoft.com/azure/machine-learning/service/how-to-create-workspace-template">Create an Azure Machine Learning service workspace by using a template</a></li>
</ul>
